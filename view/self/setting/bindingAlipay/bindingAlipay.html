<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../../../css/self/setting.css"/>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title" id="title">标题</h1>
		</header>
			<!--绑定支付宝-->
		<div class="mui-content" id="content">						
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label>真实姓名</label>
					<input id="realname" type="text" class="mui-input-clear" :value="user.realName" placeholder="请输入真实姓名">
				</div>
				<div class="mui-input-row">
					<label>支付宝账号</label>
					<input id="alipay" type="text" class="mui-input-clear" :value="user.alipayAccount" placeholder="请输入支付宝账号">
				</div>				
				<div class="mui-input-row" hidden>
					<label>手机号码</label>
					<input id="phone" type="text" class="mui-input-clear" :value="user.phone" placeholder="请输入手机号码" disabled >
				</div>
				<div class="mui-input-row">
					<label>短信验证</label>
					<input id="invitationCode" type="number" class="mui-input-clear" placeholder="请输入验证码">
					<button type="button" class="mui-btn mui-btn-outlined" onclick="smsCodeFun()"><span id="text">获取验证码</span></button>
				</div>
				<div class="mui-content-padded">		
					<button id="bindingAlipay" type="button" class="mui-btn mui-btn-block mui-btn-primary" @tap="bindingAlipay_click()">立即绑定</button>
				</div>
			</form>
		</div>
		<script src="../../../../js/mui.min.js"></script>
		<script src="../../../../js/api.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../../js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init({swipeBack: true});
			
			var vm = new Vue({
				el:'#content',
				data:{
					user:{}
				}
			})
			
			mui.plusReady(function(){
				var self = plus.webview.currentWebview();
				vm.user = self.user;
				document.getElementById("title").innerHTML = self.user.nickName;
				
			})
			
	       function smsCodeFun() {
	           var phone = document.getElementById("phone").value;
	           if(phone==''||phone.length<11){
	           		mui.toast("请输入正确的手机号码！");
	           		return;
	           }
	           if(!(/^1[3456789]\d{9}$/.test(phone))){ 
			       mui.toast("手机号码有误，请重填");  
			        return ; 
			    } 
	          	/***
				 * 获取手机短信验证码
				 */
				mui.post(httpUrl,{
					   method:'system00001',
	                   module:userApi,
	                   requestId:requestId,
					   sign:signMd5,
					   timeStamp:timeStamp,
	                   type:"4",
	                   orgId:vm.user.orgId,
	                   phone:phone
					},function(data){
						if(data.respCode=='0000'){
							mui.toast(data.respMsg);
							setTimeSms();
							return;
						}
						mui.toast(data.respMsg);
						
					},'json'
				);
	           
	       }
	       
	       /*获取验证码倒计时*/
	        var countdown=60;
	        function setTimeSms() {
	            var text = document.getElementById("text");
	            if (countdown == 0) {
	                //text.removeAttribute("disabled");
	                text.innerHTML = "获取短信";
	                countdown = 60;
	            } else {
	                //text.setAttribute("disabled", true);
	                text.innerHTML = "重新发送(" + countdown + ")";
	                countdown--;
	                setTimeout(function () {
	                    setTimeSms();
	                }, 1000)
	            }
	        }
	       
			/*绑定支付宝*/
		function bindingAlipay_click(){
			var realname = document.getElementById("realname").value;
			var alipay = document.getElementById("alipay").value;
			var smsCode = document.getElementById("invitationCode").value;
			var tel = document.getElementById("phone").value.trim();
	       		if(realname==''){
	       			mui.toast("请输入真实姓名！");
	       			return ;
	       		}
	       		if(alipay==''){
	       			mui.toast("请输入支付宝账号！");
	       			return ;
	       		}	       			       		
	       		if(smsCode==''){
	       			mui.toast("请输入验证码！");
	       			return ;
	       		}
			/*绑定支付宝user00006*/
				mui.post(httpUrl,{
					method:'user00006',
					module:userApi,
					requestId:requestId,
					sign:signMd5,
					timeStamp:timeStamp,
					id:vm.user.id,
					realName:realname,
					smsCode:smsCode,
					alipayAccount:alipay,
					alipayMoblie:tel
				},function(data){
					if(data.respCode=='0000'){
						
					    var list = plus.webview.currentWebview().opener();　　　　
                        //refresh是A页面自定义事件
                        mui.fire(list, 'refreshSetting');
						var targetUser = plus.webview.getWebviewById("view/self/self.html");
						mui.fire(targetUser, "refreshUser", {content:"刷新个人中心"});
						mui.toast("绑定成功");
						mui.back();
						return ;
					}
					mui.toast(data.respMsg)
				},'json'
					
				)
		}
		</script>
	</body>

</html>